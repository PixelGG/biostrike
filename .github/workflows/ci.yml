name: CI / CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:   # optional: f√ºr manuelles Deployment

jobs:
  # 1) Commit-Meldung
  notify-commit:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest

    steps:
      - name: Notify Discord about commit
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_COMMITS_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "FEHLER: DISCORD_WEBHOOK_URL (Commits) ist leer."
            exit 1
          fi

          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          SHORT_SHA="${GITHUB_SHA::7}"

          payload=$(cat <<EOF
          {
            "username": "BioStrike CI",
            "embeds": [{
              "title": "Neuer Commit auf ${GITHUB_REF_NAME}",
              "url": "${COMMIT_URL}",
              "description": "Repo: **${GITHUB_REPOSITORY}**",
              "color": 3447003,
              "fields": [
                { "name": "Author", "value": "${GITHUB_ACTOR}", "inline": true },
                { "name": "Commit", "value": "\`${SHORT_SHA}\`", "inline": true },
                { "name": "Event", "value": "${GITHUB_EVENT_NAME}", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

  # 2) Build / CI
  build:
    runs-on: ubuntu-latest
    # l√§uft bei push + PR
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          cd server && npm install
          cd ../client && npm install

      - name: Type check server
        run: |
          cd server && npx tsc --noEmit

      - name: Type check client
        run: |
          cd client && npx tsc --noEmit
      # Unit tests k√∂nnen in Zukunft erg√§nzt werden

      # Discord: Build erfolgreich (Embed)
      - name: Notify Discord on build success
        if: ${{ success() }}
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_BUILDS_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "FEHLER: DISCORD_WEBHOOK_URL (Builds) ist leer."
            exit 1
          fi

          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          SHORT_SHA="${GITHUB_SHA::7}"

          payload=$(cat <<EOF
          {
            "username": "BioStrike CI",
            "embeds": [{
              "title": "‚úÖ Build erfolgreich",
              "url": "${RUN_URL}",
              "description": "Repo: **${GITHUB_REPOSITORY}**\\nBranch: **${GITHUB_REF_NAME}**",
              "color": 5763719,
              "fields": [
                { "name": "Workflow", "value": "${GITHUB_WORKFLOW}", "inline": true },
                { "name": "Run ID", "value": "${GITHUB_RUN_ID}", "inline": true },
                { "name": "Commit", "value": "\`${SHORT_SHA}\`", "inline": true },
                { "name": "Actor", "value": "${GITHUB_ACTOR}", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

      # Discord: Build fehlgeschlagen (Embed)
      - name: Notify Discord on build failure
        if: ${{ failure() }}
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_BUILDS_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "FEHLER: DISCORD_WEBHOOK_URL (Builds) ist leer."
            exit 1
          fi

          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          SHORT_SHA="${GITHUB_SHA::7}"

          payload=$(cat <<EOF
          {
            "username": "BioStrike CI",
            "embeds": [{
              "title": "‚ùå Build fehlgeschlagen",
              "url": "${RUN_URL}",
              "description": "Repo: **${GITHUB_REPOSITORY}**\\nBranch: **${GITHUB_REF_NAME}**",
              "color": 15548997,
              "fields": [
                { "name": "Workflow", "value": "${GITHUB_WORKFLOW}", "inline": true },
                { "name": "Run ID", "value": "${GITHUB_RUN_ID}", "inline": true },
                { "name": "Commit", "value": "\`${SHORT_SHA}\`", "inline": true },
                { "name": "Actor", "value": "${GITHUB_ACTOR}", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

  # 3) Deployment (nur bei workflow_dispatch, also manuell)
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Build / Vorbereitung f√ºrs Deployment
        run: |
          echo "Hier sp√§ter z.B.:"
          echo "cd client && npm install && npm run build"

      - name: Deployment ausf√ºhren
        run: |
          echo "TODO: Dein echtes Deployment-Kommando eintragen (ssh, docker, etc.)"

      # Deployment erfolgreich
      - name: Notify Discord on deployment success
        if: ${{ success() }}
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOYS_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "FEHLER: DISCORD_WEBHOOK_URL (Deploys) ist leer."
            exit 1
          fi

          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          SHORT_SHA="${GITHUB_SHA::7}"

          payload=$(cat <<EOF
          {
            "username": "BioStrike CI",
            "embeds": [{
              "title": "üöÄ Deployment erfolgreich",
              "url": "${RUN_URL}",
              "description": "Repo: **${GITHUB_REPOSITORY}**",
              "color": 5763719,
              "fields": [
                { "name": "Run ID", "value": "${GITHUB_RUN_ID}", "inline": true },
                { "name": "Commit", "value": "\`${SHORT_SHA}\`", "inline": true },
                { "name": "Actor", "value": "${GITHUB_ACTOR}", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

      # Deployment fehlgeschlagen
      - name: Notify Discord on deployment failure
        if: ${{ failure() }}
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOYS_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "FEHLER: DISCORD_WEBHOOK_URL (Deploys) ist leer."
            exit 1
          fi

          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          SHORT_SHA="${GITHUB_SHA::7}"

          payload=$(cat <<EOF
          {
            "username": "BioStrike CI",
            "embeds": [{
              "title": "‚ö†Ô∏è Deployment fehlgeschlagen",
              "url": "${RUN_URL}",
              "description": "Repo: **${GITHUB_REPOSITORY}**",
              "color": 15548997,
              "fields": [
                { "name": "Run ID", "value": "${GITHUB_RUN_ID}", "inline": true },
                { "name": "Commit", "value": "\`${SHORT_SHA}\`", "inline": true },
                { "name": "Actor", "value": "${GITHUB_ACTOR}", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"
